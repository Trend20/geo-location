<!DOCTYPE html>
<html>
	<head>
		<link rel="stylesheet" href="ol.css" type="text/css" />
		<link rel="stylesheet" href="samples.css" type="text/css" />

		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	    <script src="ol.js"></script>
		<script>
		var sourceM = new ol.source.Vector();
		</script>	
	</head>
	
	<body>
		<div id="mapholder"></div>
		<div id="demo"></div>
		<script>
			var x = document.getElementById("demo");
			var zoomlevel;
			var marker;
			var map;

			function updateLocation() 
			{
				if (navigator.geolocation) 
				{
					navigator.geolocation.getCurrentPosition(showNewPosition, showError);
				}   
				else 
				{ 
					x.innerHTML = "Geolocation is not supported by this browser.";
				}
			}

			function getLocation(callback) 
			{
				zoomlevel=20;
				if (navigator.geolocation) 
				{
					navigator.geolocation.getCurrentPosition(showPosition, showError, {
					enableHighAccuracy: true ,maximumAge: 10000
					});
				}   
				else 
				{ 
					x.innerHTML = "Geolocation is not supported by this browser.";
				}
			}
	
			function showNewPosition(position)
			{		
			
				lat = parseFloat(position.coords.latitude);
				lon = parseFloat(position.coords.longitude);
								
				sourceM.clear();
				
				marker = new ol.geom.Point(ol.proj.fromLonLat(([parseFloat(lon), parseFloat(lat)])));
				
				sourceM.addFeature(new ol.Feature({
					geometry: marker,
					name: 'test'
				}));			
				map.getView().setCenter(ol.proj.transform([parseFloat(lon), parseFloat(lat)], 'EPSG:4326', 'EPSG:3857'));
				sendRequestToServer(position.coords.latitude, position.coords.longitude);  
			}
	
			function sendRequestToServer($lat,$lon)
			{

              $(document).ready(function() {
		


				$var1=$lat;
				$var2=$lon;
				querystring="InsertNewLocation.php?lat="+$lat+"&lon="+$lon;
				$.get(querystring);
			  })
			}
	
			function showPosition(position) 
			{
				lat = parseFloat(position.coords.latitude);
				lon = parseFloat(position.coords.longitude);
				
				var myLatLng = {lat: position.coords.latitude, lng: position.coords.longitude};

				marker = new ol.geom.Point(ol.proj.fromLonLat(([parseFloat(lon), parseFloat(lat)])));
				
				sourceM.addFeature(new ol.Feature({
					geometry: marker,
					name: 'test'
				}));
				
				var markerLayer = new ol.layer.Vector({
					source: sourceM,
					style: new ol.style.Style({
						image: new ol.style.Icon({
							src: 'marker.png',
							anchor: [0.5, 1]
						})
					})
				});
				
				
				//map.getView().setCenter(marker);
				map.getView().setCenter(ol.proj.transform([parseFloat(lon), parseFloat(lat)], 'EPSG:4326', 'EPSG:3857'));
				
				map.addLayer(markerLayer);
				
				sendRequestToServer(position.coords.latitude, position.coords.longitude); 

				window.setInterval("updateLocation()",5000);

				
			}		

			function showError(error) 
			{
				switch(error.code) 
				{
					case error.PERMISSION_DENIED:
						x.innerHTML = "User denied the request for Geolocation."
						break;
					case error.POSITION_UNAVAILABLE:
						x.innerHTML = "Location information is unavailable."
						break;
					case error.TIMEOUT:
						x.innerHTML = "The request to get user location timed out."
						break;
					case error.UNKNOWN_ERROR:
						x.innerHTML = "An unknown error occurred."
						break;
				}
			}
  
		</script>


	   
	   <div id="mapDiv" class="map"></div>

	   <script>
				var osmLayer = new ol.layer.Tile
				({
					source: new ol.source.OSM()
				});
				var birmingham = ol.proj.transform([-1.81185, 52.44314],'EPSG:4326', 'EPSG:3857');
				var view = new ol.View
				({
					center: birmingham,
					zoom: 17
				});
				var map = new ol.Map
				({
					target: 'mapDiv'
				});
				map.addLayer(osmLayer);
				map.setView(view);
				getLocation();
		</script>

		<div data-role="footer" data-position="fixed">
		</div>
    
	</body>
</html>
